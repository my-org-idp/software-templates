apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: deployment-template
  title: Generate Deployment Repository
  description: Create a simple deployment application
  tags:
    - deployment
    - gitops
spec:
  owner: my-org-idp
  type: service

  parameters:
    - title: Define Properties For argo.yaml
      required:
        - appname
      properties:
        appname:
          title: Application Name
          type: string
          ui:autofocus: true
        repochart:
          title: Repo Chart Name
          type: string
        chartapp:
          title: Chart Name Application
          type: string
        revisionchart:
          title: Chart Version Application
          type: string
        namespaces:
          title: Namespaces Application
          type: string
          default: 'default'
        projectname:
          title: Project Name Application
          type: string
          enum:
            - rise-apps
            - rise-infra
        env:
          title: Environment Application
          type: string
          enum:
            - dev
            - sandbox
            - production
    - title: Define Properties For values.yaml
      properties:
        arrayObjects:
          title: Define HPA Application
          type: array
          ui:options:
            addable: false
            orderable: false
            removable: false
          items:
            type: object
            properties:
              array:
                title: Array string with default value
                type: string
                default: value3
                enum:
                  - value1
                  - value2
                  - value3
              flag:
                title: Boolean flag
                type: boolean
                ui:widget: radio
              someInput:
                title: Simple text input
                type: string
    - title: Application repository Information
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Repository Location
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com
        dryRun:
          title: Only perform a dry run, don't publish anything
          type: boolean
          default: true

        owner:
          title: Owner
          type: string
          description: IdP owner of the component
          ui:field: OwnerPicker
          ui:options:
            allowedKinds:
              - Group

  steps:
    - id: template
      name: Generating component
      action: fetch:template
      input:
        url: ./skeleton
        values:
          appname: ${{ parameters.appname }}
          repochart: ${{ parameters.repochart }}
          chartapp: ${{ parameters.chartapp }}
          revisionchart: ${{ parameters.revisionchart }}
          namespaces: ${{ parameters.namespaces }}
          projectname: ${{ parameters.projectname }}
          env: ${{ parameters.env }}

    - id: publish_production
      if: ${{ parameters.dryRun !== true and parameters.env === "production" }}
      name: Publishing to Source Code Repository Production
      action: publish:github
      input:
        description: This is ${{ parameters.appname }}
        repoUrl: ${{ parameters.repoUrl }}
        branch: master
        repoVisibility: private

    # - id: publish_non_production
    #   if: ${{ parameters.dryRun !== true and parameters.env !== "production" }}
    #   name: Publishing to Source Code Repository Non Production
    #   action: publish:github
    #   input:
    #     description: This is ${{ parameters.appname }}
    #     repoUrl: ${{ parameters.repoUrl }}
    #     branch: ${{ parameters.env }}
    #     repoVisibility: private

    - id: register_production
      if: ${{ parameters.dryRun !== true and parameters.env === "production" }}
      name: Registering to the Catalog Production
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.publish_production.output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'

    # - id: register_non_production
    #   if: ${{ parameters.dryRun !== true and parameters.env !== "production" }}
    #   name: Registering to the Catalog Non Production 
    #   action: catalog:register
    #   input:
    #     repoContentsUrl: ${{ steps.publish_non_production.output.repoContentsUrl }}
    #     catalogInfoPath: '/catalog-info.yaml'

    - name: Results
      if: ${{ parameters.dryRun }}
      action: debug:log
      input:
        listWorkspace: true

  output:
    links:
      - title: Source Code Repository Production
        url: ${{ steps.publish_production.output.remoteUrl }}
      - title: Open Component in catalog Production
        icon: catalog
        entityRef: ${{ steps.register_production.output.entityRef }}
      # - title: Source Code Repository Non Production
      #   url: ${{ steps.publish_non_production.output.remoteUrl }}
      # - title: Open Component in catalog Non Production
      #   icon: catalog
      #   entityRef: ${{ steps.register_non_production.output.entityRef }}